#!/usr/bin/env bash
##delete table if exists
bq rm -f -t ga.events

##create new table based on bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*
bq query --nouse_legacy_sql --destination_table='ga.events' --time_partitioning_field event_date_partition --time_partitioning_type DAY 'SELECT event_date, PARSE_DATE("%Y%m%d", event_date) as event_date_partition , event_name, (select event.value.string_value from UNNEST(event_params) as event where event.key = "page_title") as event_params_page_title, (select event.value.string_value from UNNEST(event_params) as event where event.key = "page_location") as event_params_page_location, user_pseudo_id, device.category as device_category, device.mobile_brand_name as device_mobile_brand_name, user_first_touch_timestamp, TIMESTAMP_MICROS(user_first_touch_timestamp) as user_first_touch_at, user_ltv.revenue as user_ltv, geo.continent as geo, stream_id, traffic_source.medium as traffic_source FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`, UNNEST(event_params) as event WHERE event.key in ("page_location", "page_title") and user_ltv.revenue > 0 and geo.continent = "Asia" and traffic_source.medium = "organic"'
