#!/usr/bin/env bash
PATH=/home/iqbal/etl/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/mnt/c/Program Files/WindowsApps/CanonicalGroupLimited.Ubuntu20.04onWindows_2004.2021.825.0_x64__79rhkp1fndgsc:/mnt/c/Program Files (x86)/Common Files/Oracle/Java/javapath:/mnt/c/Program Files/Python39/Scripts/:/mnt/c/Program Files/Python39/:/mnt/c/WINDOWS/system32:/mnt/c/WINDOWS:/mnt/c/WINDOWS/System32/Wbem:/mnt/c/WINDOWS/System32/WindowsPowerShell/v1.0/:/mnt/c/WINDOWS/System32/OpenSSH/:/mnt/c/Program Files/Microsoft VS Code/bin:/mnt/c/Program Files/Git/cmd:/mnt/c/Program Files (x86)/Microsoft SQL Server/110/Tools/Binn/:/mnt/c/Program Files/Microsoft SQL Server/110/Tools/Binn/:/mnt/c/Program Files/Microsoft SQL Server/110/DTS/Binn/:/mnt/c/Program Files (x86)/Microsoft SQL Server/110/Tools/Binn/ManagementStudio/:/mnt/c/Program Files (x86)/Microsoft Visual Studio 10.0/Common7/IDE/PrivateAssemblies/:/mnt/c/Program Files (x86)/Microsoft SQL Server/110/DTS/Binn/:/mnt/c/Program Files/Microsoft SQL Server/Client SDK/ODBC/110/Tools/Binn/:/mnt/c/Program Files (x86)/Microsoft SQL Server/120/Tools/Binn/:/mnt/c/Program Files/Microsoft SQL Server/120/Tools/Binn/:/mnt/c/Program Files/Microsoft SQL Server/120/DTS/Binn/:/mnt/c/Program Files (x86)/Microsoft SQL Server/120/Tools/Binn/ManagementStudio/:/mnt/c/Program Files (x86)/Microsoft SQL Server/120/DTS/Binn/:/mnt/c/Program Files/Pandoc/:/mnt/c/Program Files/MiKTeX 2.9/miktex/bin/x64/:/mnt/c/Program Files/MongoDB/Server/4.4/bin:/mnt/c/Program Files/MySQL/MySQL Server 5.7/bin/:/mnt/c/Program Files/PostgreSQL/14/bin:/mnt/c/Program Files/Docker/Docker/resources/bin:/mnt/c/ProgramData/DockerDesktop/version-bin:/mnt/c/Users/Telkom/Anaconda3:/mnt/c/Users/Telkom/Anaconda3/Library/mingw-w64/bin:/mnt/c/Users/Telkom/Anaconda3/Library/usr/bin:/mnt/c/Users/Telkom/Anaconda3/Library/bin:/mnt/c/Users/Telkom/Anaconda3/Scripts:/mnt/c/Users/Telkom/Anaconda3 /Scripts:/mnt/c/Users/Telkom/AppData/Local/Microsoft/WindowsApps:/mnt/c/Users/Telkom/AppData/Local/Programs/Microsoft VS Code/bin:/mnt/c/Users/Telkom/Desktop/python-for-data-engineering-master/venv/python.exe:/mnt/c/Users/Telkom/AppData/Local/JetBrains/PyCharm Community Edition 2021.1.2/bin:/mnt/c/Users/Telkom/AppData/Local/Google/Cloud SDK/google-cloud-sdk/bin:/snap/bin

##delete table if exists
bq rm -f -t ga.events

##create new table based on bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*
bq query --nouse_legacy_sql --destination_table='ga.events' --time_partitioning_field event_date_partition --time_partitioning_type DAY 'SELECT event_date, PARSE_DATE("%Y%m%d", event_date) as event_date_partition , event_name, (select event.value.string_value from UNNEST(event_params) as event where event.key = "page_title") as event_params_page_title, (select event.value.string_value from UNNEST(event_params) as event where event.key = "page_location") as event_params_page_location, user_pseudo_id, device.category as device_category, device.mobile_brand_name as device_mobile_brand_name, user_first_touch_timestamp, TIMESTAMP_MICROS(user_first_touch_timestamp) as user_first_touch_at, user_ltv.revenue as user_ltv, geo.continent as geo, stream_id, traffic_source.medium as traffic_source FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`, UNNEST(event_params) as event WHERE event.key in ("page_location", "page_title") and user_ltv.revenue > 0 and geo.continent = "Asia" and traffic_source.medium = "organic"'